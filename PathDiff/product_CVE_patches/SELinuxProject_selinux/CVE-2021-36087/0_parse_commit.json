{
    "current_hash": "340f0eb7f3673e8aacaf0a96cbfcd4d12a405521",
    "parent_hash": "8a74c05b97050bd226d61fc162e04dcdf8e91247",
    "modified_file_0": {
        "mod_filename": "libsepol/cil/src/cil_build_ast.c",
        "status": "modified",
        "add_lines": 32,
        "dele_lines": 0,
        "patch": "@@ -52,6 +52,7 @@ struct cil_args_build {\n \tstruct cil_tree_node *tunif;\n \tstruct cil_tree_node *in;\n \tstruct cil_tree_node *macro;\n+\tstruct cil_tree_node *optional;\n \tstruct cil_tree_node *boolif;\n };\n \n@@ -6071,6 +6072,7 @@ int __cil_build_ast_node_helper(struct cil_tree_node *parse_current, uint32_t *f\n \tstruct cil_tree_node *tunif = args->tunif;\n \tstruct cil_tree_node *in = args->in;\n \tstruct cil_tree_node *macro = args->macro;\n+\tstruct cil_tree_node *optional = args->optional;\n \tstruct cil_tree_node *boolif = args->boolif;\n \tstruct cil_tree_node *ast_node = NULL;\n \tint rc = SEPOL_ERR;\n@@ -6121,6 +6123,18 @@ int __cil_build_ast_node_helper(struct cil_tree_node *parse_current, uint32_t *f\n \t\t}\n \t}\n \n+\tif (optional != NULL) {\n+\t\tif (parse_current->data == CIL_KEY_TUNABLE ||\n+\t\t\tparse_current->data == CIL_KEY_IN ||\n+\t\t\tparse_current->data == CIL_KEY_BLOCK ||\n+\t\t\tparse_current->data == CIL_KEY_BLOCKABSTRACT ||\n+\t\t\tparse_current->data == CIL_KEY_MACRO) {\n+\t\t\trc = SEPOL_ERR;\n+\t\t\tcil_tree_log(parse_current, CIL_ERR, \"%s is not allowed in optionals\", (char *)parse_current->data);\n+\t\t\tgoto exit;\n+\t\t}\n+\t}\n+\n \tif (boolif != NULL) {\n \t\tif (parse_current->data != CIL_KEY_TUNABLEIF &&\n \t\t\tparse_current->data != CIL_KEY_CALL &&\n@@ -6462,6 +6476,10 @@ int __cil_build_ast_first_child_helper(__attribute__((unused)) struct cil_tree_n\n \t\targs->macro = ast;\n \t}\n \n+\tif (ast->flavor == CIL_OPTIONAL) {\n+\t\targs->optional = ast;\n+\t}\n+\n \tif (ast->flavor == CIL_BOOLEANIF) {\n \t\targs->boolif = ast;\n \t}\n@@ -6492,6 +6510,19 @@ int __cil_build_ast_last_child_helper(struct cil_tree_node *parse_current, void\n \t\targs->macro = NULL;\n \t}\n \n+\tif (ast->flavor == CIL_OPTIONAL) {\n+\t\tstruct cil_tree_node *n = ast->parent;\n+\t\targs->optional = NULL;\n+\t\t/* Optionals can be nested */\n+\t\twhile (n && n->flavor != CIL_ROOT) {\n+\t\t\tif (n->flavor == CIL_OPTIONAL) {\n+\t\t\t\targs->optional = n;\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t\tn = n->parent;\n+\t\t}\n+\t}\n+\n \tif (ast->flavor == CIL_BOOLEANIF) {\n \t\targs->boolif = NULL;\n \t}\n@@ -6520,6 +6551,7 @@ int cil_build_ast(struct cil_db *db, struct cil_tree_node *parse_tree, struct ci\n \textra_args.tunif = NULL;\n \textra_args.in = NULL;\n \textra_args.macro = NULL;\n+\textra_args.optional = NULL;\n \textra_args.boolif = NULL;\n \n \trc = cil_tree_walk(parse_tree, __cil_build_ast_node_helper, __cil_build_ast_first_child_helper, __cil_build_ast_last_child_helper, &extra_args);"
    },
    "modified_file_1": {
        "mod_filename": "libsepol/cil/src/cil_resolve_ast.c",
        "status": "modified",
        "add_lines": 3,
        "dele_lines": 1,
        "patch": "@@ -3808,8 +3808,10 @@ int __cil_resolve_ast_node_helper(struct cil_tree_node *node, uint32_t *finished\n \n \tif (optional != NULL) {\n \t\tif (node->flavor == CIL_TUNABLE ||\n+\t\t\tnode->flavor == CIL_IN ||\n+\t\t\tnode->flavor == CIL_BLOCK ||\n+\t\t\tnode->flavor == CIL_BLOCKABSTRACT ||\n \t\t    node->flavor == CIL_MACRO) {\n-\t\t\t/* tuanbles and macros are not allowed in optionals*/\n \t\t\tcil_tree_log(node, CIL_ERR, \"%s statement is not allowed in optionals\", cil_node_to_string(node));\n \t\t\trc = SEPOL_ERR;\n \t\t\tgoto exit;"
    }
}