{
    "current_hash": "424be345639d75c6cb7d0bd2da5f0f407dbd0bd5",
    "parent_hash": "183954bed3ba9f9897979fd48d8375d7aab85b80",
    "modified_file_0": {
        "mod_filename": "main/manager.c",
        "status": "modified",
        "add_lines": 39,
        "dele_lines": 3,
        "patch": "@@ -3752,12 +3752,43 @@ void astman_live_dangerously(int new_live_dangerously)\n \tlive_dangerously = new_live_dangerously;\n }\n \n+/**\n+ * \\brief Check if a file is restricted or not\n+ *\n+ * \\return 0 on success\n+ * \\return 1 on restricted file\n+ * \\return -1 on failure\n+ */\n static int restrictedFile(const char *filename)\n {\n-\tif (!live_dangerously && !strncasecmp(filename, \"/\", 1) &&\n-\t\t strncasecmp(filename, ast_config_AST_CONFIG_DIR, strlen(ast_config_AST_CONFIG_DIR))) {\n+\tchar *stripped_filename;\n+\tRAII_VAR(char *, path, NULL, ast_free);\n+\tRAII_VAR(char *, real_path, NULL, ast_free);\n+\n+\tif (live_dangerously) {\n+\t\treturn 0;\n+\t}\n+\n+\tstripped_filename = ast_strip(ast_strdupa(filename));\n+\n+\t/* If the file path starts with '/', don't prepend ast_config_AST_CONFIG_DIR */\n+\tif (stripped_filename[0] == '/') {\n+\t\treal_path = realpath(stripped_filename, NULL);\n+\t} else {\n+\t\tif (ast_asprintf(&path, \"%s/%s\", ast_config_AST_CONFIG_DIR, stripped_filename) == -1) {\n+\t\t\treturn -1;\n+\t\t}\n+\t\treal_path = realpath(path, NULL);\n+\t}\n+\n+\tif (!real_path) {\n+\t\treturn -1;\n+\t}\n+\n+\tif (!ast_begins_with(real_path, ast_config_AST_CONFIG_DIR)) {\n \t\treturn 1;\n \t}\n+\n \treturn 0;\n }\n \n@@ -3770,6 +3801,7 @@ static int action_getconfig(struct mansession *s, const struct message *m)\n \tconst char *category_name;\n \tint catcount = 0;\n \tint lineno = 0;\n+\tint ret = 0;\n \tstruct ast_category *cur_category = NULL;\n \tstruct ast_variable *v;\n \tstruct ast_flags config_flags = { CONFIG_FLAG_WITHCOMMENTS | CONFIG_FLAG_NOCACHE };\n@@ -3779,9 +3811,13 @@ static int action_getconfig(struct mansession *s, const struct message *m)\n \t\treturn 0;\n \t}\n \n-\tif (restrictedFile(fn)) {\n+\tret = restrictedFile(fn);\n+\tif (ret == 1) {\n \t\tastman_send_error(s, m, \"File requires escalated priveledges\");\n \t\treturn 0;\n+\t} else if (ret == -1) {\n+\t\tastman_send_error(s, m, \"Config file not found\");\n+\t\treturn 0;\n \t}\n \n \tcfg = ast_config_load2(fn, \"manager\", config_flags);"
    }
}