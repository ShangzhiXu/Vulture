{
    "current_hash": "1cd644db8c23a2f530ddb93cebed7dacc5f5721a",
    "parent_hash": "1d1577c929e3486a9d7e98c4f66329ce8fd0f3e7",
    "modified_file_0": {
        "mod_filename": "src/shared/att.c",
        "status": "modified",
        "add_lines": 40,
        "dele_lines": 6,
        "patch": "@@ -84,6 +84,7 @@ struct bt_att {\n \tstruct queue *req_queue;\t/* Queued ATT protocol requests */\n \tstruct queue *ind_queue;\t/* Queued ATT protocol indications */\n \tstruct queue *write_queue;\t/* Queue of PDUs ready to send */\n+\tbool in_disc;\t\t\t/* Cleanup queues on disconnect_cb */\n \n \tbt_att_timeout_func_t timeout_callback;\n \tbt_att_destroy_func_t timeout_destroy;\n@@ -222,8 +223,10 @@ static void destroy_att_send_op(void *data)\n \tfree(op);\n }\n \n-static void cancel_att_send_op(struct att_send_op *op)\n+static void cancel_att_send_op(void *data)\n {\n+\tstruct att_send_op *op = data;\n+\n \tif (op->destroy)\n \t\top->destroy(op->user_data);\n \n@@ -631,11 +634,6 @@ static bool disconnect_cb(struct io *io, void *user_data)\n \t/* Dettach channel */\n \tqueue_remove(att->chans, chan);\n \n-\t/* Notify request callbacks */\n-\tqueue_remove_all(att->req_queue, NULL, NULL, disc_att_send_op);\n-\tqueue_remove_all(att->ind_queue, NULL, NULL, disc_att_send_op);\n-\tqueue_remove_all(att->write_queue, NULL, NULL, disc_att_send_op);\n-\n \tif (chan->pending_req) {\n \t\tdisc_att_send_op(chan->pending_req);\n \t\tchan->pending_req = NULL;\n@@ -654,6 +652,15 @@ static bool disconnect_cb(struct io *io, void *user_data)\n \n \tbt_att_ref(att);\n \n+\tatt->in_disc = true;\n+\n+\t/* Notify request callbacks */\n+\tqueue_remove_all(att->req_queue, NULL, NULL, disc_att_send_op);\n+\tqueue_remove_all(att->ind_queue, NULL, NULL, disc_att_send_op);\n+\tqueue_remove_all(att->write_queue, NULL, NULL, disc_att_send_op);\n+\n+\tatt->in_disc = false;\n+\n \tqueue_foreach(att->disconn_list, disconn_handler, INT_TO_PTR(err));\n \n \tbt_att_unregister_all(att);\n@@ -1574,6 +1581,30 @@ bool bt_att_chan_cancel(struct bt_att_chan *chan, unsigned int id)\n \treturn true;\n }\n \n+static bool bt_att_disc_cancel(struct bt_att *att, unsigned int id)\n+{\n+\tstruct att_send_op *op;\n+\n+\top = queue_find(att->req_queue, match_op_id, UINT_TO_PTR(id));\n+\tif (op)\n+\t\tgoto done;\n+\n+\top = queue_find(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n+\tif (op)\n+\t\tgoto done;\n+\n+\top = queue_find(att->write_queue, match_op_id, UINT_TO_PTR(id));\n+\n+done:\n+\tif (!op)\n+\t\treturn false;\n+\n+\t/* Just cancel since disconnect_cb will be cleaning up */\n+\tcancel_att_send_op(op);\n+\n+\treturn true;\n+}\n+\n bool bt_att_cancel(struct bt_att *att, unsigned int id)\n {\n \tconst struct queue_entry *entry;\n@@ -1591,6 +1622,9 @@ bool bt_att_cancel(struct bt_att *att, unsigned int id)\n \t\t\treturn true;\n \t}\n \n+\tif (att->in_disc)\n+\t\treturn bt_att_disc_cancel(att, id);\n+\n \top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n \tif (op)\n \t\tgoto done;"
    }
}