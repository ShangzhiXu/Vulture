{
    "current_hash": "b497b5942a8beb8f89ca1c359c54ad67ec843055",
    "parent_hash": "bb27e5e1be7cbaac09aef5ff7a79f71a2ad8d113",
    "modified_file_0": {
        "mod_filename": "src/adapter.c",
        "status": "modified",
        "add_lines": 22,
        "dele_lines": 13,
        "patch": "@@ -560,7 +560,11 @@ static void settings_changed(struct btd_adapter *adapter, uint32_t settings)\n \tif (changed_mask & MGMT_SETTING_DISCOVERABLE) {\n \t\tg_dbus_emit_property_changed(dbus_conn, adapter->path,\n \t\t\t\t\tADAPTER_INTERFACE, \"Discoverable\");\n-\t\tstore_adapter_info(adapter);\n+\t\t/* Only persist discoverable setting if it was not set\n+\t\t * temporarily by discovery.\n+\t\t */\n+\t\tif (!adapter->discovery_discoverable)\n+\t\t\tstore_adapter_info(adapter);\n \t\tbtd_adv_manager_refresh(adapter->adv_manager);\n \t}\n \n@@ -2162,8 +2166,6 @@ static bool filters_equal(struct mgmt_cp_start_service_discovery *a,\n static int update_discovery_filter(struct btd_adapter *adapter)\n {\n \tstruct mgmt_cp_start_service_discovery *sd_cp;\n-\tGSList *l;\n-\n \n \tDBG(\"\");\n \n@@ -2173,17 +2175,24 @@ static int update_discovery_filter(struct btd_adapter *adapter)\n \t\treturn -ENOMEM;\n \t}\n \n-\tfor (l = adapter->discovery_list; l; l = g_slist_next(l)) {\n-\t\tstruct discovery_client *client = l->data;\n+\t/* Only attempt to overwrite current discoverable setting when not\n+\t * discoverable.\n+\t */\n+\tif (!(adapter->current_settings & MGMT_OP_SET_DISCOVERABLE)) {\n+\t\tGSList *l;\n \n-\t\tif (!client->discovery_filter)\n-\t\t\tcontinue;\n+\t\tfor (l = adapter->discovery_list; l; l = g_slist_next(l)) {\n+\t\t\tstruct discovery_client *client = l->data;\n \n-\t\tif (client->discovery_filter->discoverable)\n-\t\t\tbreak;\n-\t}\n+\t\t\tif (!client->discovery_filter)\n+\t\t\t\tcontinue;\n \n-\tset_discovery_discoverable(adapter, l ? true : false);\n+\t\t\tif (client->discovery_filter->discoverable) {\n+\t\t\t\tset_discovery_discoverable(adapter, true);\n+\t\t\t\tbreak;\n+\t\t\t}\n+\t\t}\n+\t}\n \n \t/*\n \t * If filters are equal, then don't update scan, except for when\n@@ -2216,8 +2225,7 @@ static int discovery_stop(struct discovery_client *client)\n \t\treturn 0;\n \t}\n \n-\tif (adapter->discovery_discoverable)\n-\t\tset_discovery_discoverable(adapter, false);\n+\tset_discovery_discoverable(adapter, false);\n \n \t/*\n \t * In the idle phase of a discovery, there is no need to stop it\n@@ -6913,6 +6921,7 @@ static void adapter_stop(struct btd_adapter *adapter)\n \tg_free(adapter->current_discovery_filter);\n \tadapter->current_discovery_filter = NULL;\n \n+\tset_discovery_discoverable(adapter, false);\n \tadapter->discovering = false;\n \n \twhile (adapter->connections) {"
    }
}