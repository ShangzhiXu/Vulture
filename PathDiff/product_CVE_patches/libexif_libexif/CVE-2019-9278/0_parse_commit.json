{
    "current_hash": "75aa73267fdb1e0ebfbc00369e7312bac43d0566",
    "parent_hash": "da025b3b85f076f8739ce3046c1de87f8670795c",
    "modified_file_0": {
        "mod_filename": "libexif/exif-data.c",
        "status": "modified",
        "add_lines": 18,
        "dele_lines": 10,
        "patch": "@@ -192,9 +192,15 @@ exif_data_load_data_entry (ExifData *data, ExifEntry *entry,\n \t\tdoff = offset + 8;\n \n \t/* Sanity checks */\n-\tif ((doff + s < doff) || (doff + s < s) || (doff + s > size)) {\n+\tif (doff >= size) {\n \t\texif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, \"ExifData\",\n-\t\t\t\t  \"Tag data past end of buffer (%u > %u)\", doff+s, size);\t\n+\t\t\t\t  \"Tag starts past end of buffer (%u > %u)\", doff, size);\n+\t\treturn 0;\n+\t}\n+\n+\tif (s > size - doff) {\n+\t\texif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, \"ExifData\",\n+\t\t\t\t  \"Tag data goes past end of buffer (%u > %u)\", doff+s, size);\n \t\treturn 0;\n \t}\n \n@@ -315,13 +321,14 @@ exif_data_load_data_thumbnail (ExifData *data, const unsigned char *d,\n \t\t\t       unsigned int ds, ExifLong o, ExifLong s)\n {\n \t/* Sanity checks */\n-\tif ((o + s < o) || (o + s < s) || (o + s > ds) || (o > ds)) {\n-\t\texif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, \"ExifData\",\n-\t\t\t  \"Bogus thumbnail offset (%u) or size (%u).\",\n-\t\t\t  o, s);\n+\tif (o >= ds) {\n+\t\texif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, \"ExifData\", \"Bogus thumbnail offset (%u).\", o);\n+\t\treturn;\n+\t}\n+\tif (s > ds - o) {\n+\t\texif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, \"ExifData\", \"Bogus thumbnail size (%u), max would be %u.\", s, ds-o);\n \t\treturn;\n \t}\n-\n \tif (data->data) \n \t\texif_mem_free (data->priv->mem, data->data);\n \tif (!(data->data = exif_data_alloc (data, s))) {\n@@ -947,7 +954,7 @@ exif_data_load_data (ExifData *data, const unsigned char *d_orig,\n \texif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, \"ExifData\", \n \t\t  \"IFD 0 at %i.\", (int) offset);\n \n-\t/* Sanity check the offset, being careful about overflow */\n+\t/* ds is restricted to 16 bit above, so offset is restricted too, and offset+8 should not overflow. */\n \tif (offset > ds || offset + 6 + 2 > ds)\n \t\treturn;\n \n@@ -956,6 +963,7 @@ exif_data_load_data (ExifData *data, const unsigned char *d_orig,\n \n \t/* IFD 1 offset */\n \tn = exif_get_short (d + 6 + offset, data->priv->order);\n+\t/* offset < 2<<16, n is 16 bit at most, so this op will not overflow */\n \tif (offset + 6 + 2 + 12 * n + 4 > ds)\n \t\treturn;\n \n@@ -964,8 +972,8 @@ exif_data_load_data (ExifData *data, const unsigned char *d_orig,\n \t\texif_log (data->priv->log, EXIF_LOG_CODE_DEBUG, \"ExifData\",\n \t\t\t  \"IFD 1 at %i.\", (int) offset);\n \n-\t\t/* Sanity check. */\n-\t\tif (offset > ds || offset + 6 > ds) {\n+\t\t/* Sanity check. ds is ensured to be above 6 above, offset is 16bit */\n+\t\tif (offset > ds - 6) {\n \t\t\texif_log (data->priv->log, EXIF_LOG_CODE_CORRUPT_DATA,\n \t\t\t\t  \"ExifData\", \"Bogus offset of IFD1.\");\n \t\t} else {"
    }
}