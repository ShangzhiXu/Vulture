{
    "current_hash": "e6a38a1a23ba94d139b1fa2cd4519fdcfe3c9bab",
    "parent_hash": "bbd35b1f591b960575d8c77921f93cbedfd69e7d",
    "modified_file_0": {
        "mod_filename": "libexif/canon/exif-mnote-data-canon.c",
        "status": "modified",
        "add_lines": 21,
        "dele_lines": 0,
        "patch": "@@ -32,6 +32,9 @@\n \n #define CHECKOVERFLOW(offset,datasize,structsize) (( offset >= datasize) || (structsize > datasize) || (offset > datasize - structsize ))\n \n+/* Total size limit to prevent abuse by DoS */\n+#define FAILSAFE_SIZE_MAX 1000000L\n+\n static void\n exif_mnote_data_canon_clear (ExifMnoteDataCanon *n)\n {\n@@ -204,6 +207,7 @@ exif_mnote_data_canon_load (ExifMnoteData *ne,\n \tExifMnoteDataCanon *n = (ExifMnoteDataCanon *) ne;\n \tExifShort c;\n \tsize_t i, tcount, o, datao;\n+\tlong failsafe_size = 0;\n \n \tif (!n || !buf || !buf_size) {\n \t\texif_log (ne->log, EXIF_LOG_CODE_CORRUPT_DATA,\n@@ -295,6 +299,23 @@ exif_mnote_data_canon_load (ExifMnoteData *ne,\n \t\t\tmemcpy (n->entries[tcount].data, buf + dataofs, s);\n \t\t}\n \n+\t\t/* Track the size of decoded tag data. A malicious file could\n+\t\t * be crafted to cause extremely large values here without\n+\t\t * tripping any buffer range checks.  This is especially bad\n+\t\t * with the libexif representation of Canon MakerNotes because\n+\t\t * some arrays are turned into individual tags that the\n+\t\t * application must loop around. */\n+\t\tfailsafe_size += mnote_canon_entry_count_values(&n->entries[tcount]);\n+\n+\t\tif (failsafe_size > FAILSAFE_SIZE_MAX) {\n+\t\t\t/* Abort if the total size of the data in the tags extraordinarily large, */\n+\t\t\texif_mem_free (ne->mem, n->entries[tcount].data);\n+\t\t\texif_log (ne->log, EXIF_LOG_CODE_CORRUPT_DATA,\n+\t\t\t\t\t  \"ExifMnoteCanon\", \"Failsafe tag size overflow (%lu > %ld)\",\n+\t\t\t\t\t  failsafe_size, FAILSAFE_SIZE_MAX);\n+\t\t\tbreak;\n+\t\t}\n+\n \t\t/* Tag was successfully parsed */\n \t\t++tcount;\n \t}"
    }
}