{
    "current_hash": "2899351224fe2940aec37d7656e1e392c0fe07f0",
    "parent_hash": "daf45e1b7e22c9346778af9a89bc6e7cd197db94",
    "modified_file_0": {
        "mod_filename": "programs/pluto/ikev2_parent.c",
        "status": "modified",
        "add_lines": 18,
        "dele_lines": 13,
        "patch": "@@ -306,8 +306,6 @@ static void ikev2_parent_outI1_continue(struct pluto_crypto_req_cont *pcrc,\n \t}\n \treset_cur_state();\n \treset_globals();\n-\n-\tpassert(GLOBALS_ARE_RESET());\n }\n \n /*\n@@ -729,18 +727,31 @@ stf_status ikev2parent_inI1outR1(struct msg_digest *md)\n \t */\n \t{\n \t\tstruct ikev2_ke *ke;\n+\t\tchar fromname[ADDRTOT_BUF];\n+\t\taddrtot(&md->sender, 0, fromname, ADDRTOT_BUF);\n+\n+\t\tif (!md->chain[ISAKMP_NEXT_v2KE]) {\n+\t\t\t/* is this a notify? If so, log it */\n+\t\t\tif(md->chain[ISAKMP_NEXT_v2N]) {\n+\t\t\t\tlibreswan_log(\"Received Notify(%d): %s\",\n+\t\t\t\t\tmd->chain[ISAKMP_NEXT_v2N]->payload.v2n.isan_type,\n+\t\t\t\t\tenum_name(&ikev2_notify_names,\n+\t\t\t\t\t\tmd->chain[ISAKMP_NEXT_v2N]->payload.v2n.isan_type));\n+\t\t\t}\n+\t\t\tlibreswan_log(\n+\t\t\t\t\"rejecting I1 from %s:%u, no KE payload present\",\n+\t\t\t\tfromname, md->sender_port);\n+\t\t\treturn STF_FAIL + v2N_INVALID_KE_PAYLOAD;\n+\t\t}\n \t\tke = &md->chain[ISAKMP_NEXT_v2KE]->payload.v2ke;\n \n \t\tst->st_oakley.group = lookup_group(ke->isak_group);\n \t\tif (st->st_oakley.group == NULL) {\n-\t\t\tchar fromname[ADDRTOT_BUF];\n-\n-\t\t\taddrtot(&md->sender, 0, fromname, ADDRTOT_BUF);\n \t\t\tlibreswan_log(\n \t\t\t\t\"rejecting I1 from %s:%u, invalid DH group=%u\",\n \t\t\t\tfromname, md->sender_port,\n \t\t\t\tke->isak_group);\n-\t\t\treturn v2N_INVALID_KE_PAYLOAD;\n+\t\t\treturn STF_FAIL + v2N_INVALID_KE_PAYLOAD;\n \t\t}\n \t}\n \n@@ -819,8 +830,6 @@ static void ikev2_parent_inI1outR1_continue(struct pluto_crypto_req_cont *pcrc,\n \t\t\trelease_md(ke->md);\n \t}\n \treset_globals();\n-\n-\tpassert(GLOBALS_ARE_RESET());\n }\n \n static stf_status ikev2_parent_inI1outR1_tail(\n@@ -1145,8 +1154,6 @@ static void ikev2_parent_inR1outI2_continue(struct pluto_crypto_req_cont *pcrc,\n \t\t\trelease_md(dh->md);\n \t}\n \treset_globals();\n-\n-\tpassert(GLOBALS_ARE_RESET());\n }\n \n static void ikev2_padup_pre_encrypt(struct msg_digest *md,\n@@ -1714,7 +1721,7 @@ stf_status ikev2parent_inI2outR2(struct msg_digest *md)\n \t/* verify that there is in fact an encrypted payload */\n \tif (!md->chain[ISAKMP_NEXT_v2E]) {\n \t\tlibreswan_log(\"R2 state should receive an encrypted payload\");\n-\t\treset_globals();\n+\t\treset_globals(); /* XXX suspicious - why was this deemed neccessary? */\n \t\treturn STF_FATAL;\n \t}\n \n@@ -1794,8 +1801,6 @@ static void ikev2_parent_inI2outR2_continue(struct pluto_crypto_req_cont *pcrc,\n \t\t\trelease_md(dh->md);\n \t}\n \treset_globals();\n-\n-\tpassert(GLOBALS_ARE_RESET());\n }\n \n static stf_status ikev2_parent_inI2outR2_tail("
    }
}