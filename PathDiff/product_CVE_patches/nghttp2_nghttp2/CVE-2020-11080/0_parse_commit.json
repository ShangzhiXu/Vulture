{
    "current_hash": "336a98feb0d56b9ac54e12736b18785c27f75090",
    "parent_hash": "3b17a659f69fb2ef5d2239142437da2902e61911",
    "modified_file_0": {
        "mod_filename": "doc/CMakeLists.txt",
        "status": "modified",
        "add_lines": 1,
        "dele_lines": 0,
        "patch": "@@ -42,6 +42,7 @@ set(APIDOCS\n   nghttp2_option_set_no_recv_client_magic.rst\n   nghttp2_option_set_peer_max_concurrent_streams.rst\n   nghttp2_option_set_user_recv_extension_type.rst\n+  nghttp2_option_set_max_settings.rst\n   nghttp2_pack_settings_payload.rst\n   nghttp2_priority_spec_check_default.rst\n   nghttp2_priority_spec_default_init.rst"
    },
    "modified_file_1": {
        "mod_filename": "doc/Makefile.am",
        "status": "modified",
        "add_lines": 1,
        "dele_lines": 0,
        "patch": "@@ -69,6 +69,7 @@ APIDOCS= \\\n \tnghttp2_option_set_peer_max_concurrent_streams.rst \\\n \tnghttp2_option_set_user_recv_extension_type.rst \\\n \tnghttp2_option_set_max_outbound_ack.rst \\\n+\tnghttp2_option_set_max_settings.rst \\\n \tnghttp2_pack_settings_payload.rst \\\n \tnghttp2_priority_spec_check_default.rst \\\n \tnghttp2_priority_spec_default_init.rst \\"
    },
    "modified_file_2": {
        "mod_filename": "lib/includes/nghttp2/nghttp2.h",
        "status": "modified",
        "add_lines": 23,
        "dele_lines": 0,
        "patch": "@@ -228,6 +228,13 @@ typedef struct {\n  */\n #define NGHTTP2_CLIENT_MAGIC_LEN 24\n \n+/**\n+ * @macro\n+ *\n+ * The default max number of settings per SETTINGS frame\n+ */\n+#define NGHTTP2_DEFAULT_MAX_SETTINGS 32\n+\n /**\n  * @enum\n  *\n@@ -398,6 +405,11 @@ typedef enum {\n    * receives an other type of frame.\n    */\n   NGHTTP2_ERR_SETTINGS_EXPECTED = -536,\n+  /**\n+   * When a local endpoint receives too many settings entries\n+   * in a single SETTINGS frame.\n+   */\n+  NGHTTP2_ERR_TOO_MANY_SETTINGS = -537,\n   /**\n    * The errors < :enum:`NGHTTP2_ERR_FATAL` mean that the library is\n    * under unexpected condition and processing was terminated (e.g.,\n@@ -2659,6 +2671,17 @@ NGHTTP2_EXTERN void nghttp2_option_set_no_closed_streams(nghttp2_option *option,\n NGHTTP2_EXTERN void nghttp2_option_set_max_outbound_ack(nghttp2_option *option,\n                                                         size_t val);\n \n+/**\n+ * @function\n+ *\n+ * This function sets the maximum number of SETTINGS entries per\n+ * SETTINGS frame that will be accepted. If more than those entries\n+ * are received, the peer is considered to be misbehaving and session\n+ * will be closed. The default value is 32.\n+ */\n+NGHTTP2_EXTERN void nghttp2_option_set_max_settings(nghttp2_option *option,\n+                                                    size_t val);\n+\n /**\n  * @function\n  *"
    },
    "modified_file_3": {
        "mod_filename": "lib/nghttp2_helper.c",
        "status": "modified",
        "add_lines": 2,
        "dele_lines": 0,
        "patch": "@@ -334,6 +334,8 @@ const char *nghttp2_strerror(int error_code) {\n   case NGHTTP2_ERR_FLOODED:\n     return \"Flooding was detected in this HTTP/2 session, and it must be \"\n            \"closed\";\n+  case NGHTTP2_ERR_TOO_MANY_SETTINGS:\n+    return \"SETTINGS frame contained more than the maximum allowed entries\";\n   default:\n     return \"Unknown error code\";\n   }"
    },
    "modified_file_4": {
        "mod_filename": "lib/nghttp2_option.c",
        "status": "modified",
        "add_lines": 5,
        "dele_lines": 0,
        "patch": "@@ -121,3 +121,8 @@ void nghttp2_option_set_max_outbound_ack(nghttp2_option *option, size_t val) {\n   option->opt_set_mask |= NGHTTP2_OPT_MAX_OUTBOUND_ACK;\n   option->max_outbound_ack = val;\n }\n+\n+void nghttp2_option_set_max_settings(nghttp2_option *option, size_t val) {\n+  option->opt_set_mask |= NGHTTP2_OPT_MAX_SETTINGS;\n+  option->max_settings = val;\n+}"
    },
    "modified_file_5": {
        "mod_filename": "lib/nghttp2_option.h",
        "status": "modified",
        "add_lines": 5,
        "dele_lines": 0,
        "patch": "@@ -67,6 +67,7 @@ typedef enum {\n   NGHTTP2_OPT_MAX_DEFLATE_DYNAMIC_TABLE_SIZE = 1 << 9,\n   NGHTTP2_OPT_NO_CLOSED_STREAMS = 1 << 10,\n   NGHTTP2_OPT_MAX_OUTBOUND_ACK = 1 << 11,\n+  NGHTTP2_OPT_MAX_SETTINGS = 1 << 12,\n } nghttp2_option_flag;\n \n /**\n@@ -85,6 +86,10 @@ struct nghttp2_option {\n    * NGHTTP2_OPT_MAX_OUTBOUND_ACK\n    */\n   size_t max_outbound_ack;\n+  /**\n+   * NGHTTP2_OPT_MAX_SETTINGS\n+   */\n+  size_t max_settings;\n   /**\n    * Bitwise OR of nghttp2_option_flag to determine that which fields\n    * are specified."
    },
    "modified_file_6": {
        "mod_filename": "lib/nghttp2_session.c",
        "status": "modified",
        "add_lines": 21,
        "dele_lines": 0,
        "patch": "@@ -458,6 +458,7 @@ static int session_new(nghttp2_session **session_ptr,\n \n   (*session_ptr)->max_send_header_block_length = NGHTTP2_MAX_HEADERSLEN;\n   (*session_ptr)->max_outbound_ack = NGHTTP2_DEFAULT_MAX_OBQ_FLOOD_ITEM;\n+  (*session_ptr)->max_settings = NGHTTP2_DEFAULT_MAX_SETTINGS;\n \n   if (option) {\n     if ((option->opt_set_mask & NGHTTP2_OPT_NO_AUTO_WINDOW_UPDATE) &&\n@@ -521,6 +522,11 @@ static int session_new(nghttp2_session **session_ptr,\n     if (option->opt_set_mask & NGHTTP2_OPT_MAX_OUTBOUND_ACK) {\n       (*session_ptr)->max_outbound_ack = option->max_outbound_ack;\n     }\n+\n+    if ((option->opt_set_mask & NGHTTP2_OPT_MAX_SETTINGS) &&\n+        option->max_settings) {\n+      (*session_ptr)->max_settings = option->max_settings;\n+    }\n   }\n \n   rv = nghttp2_hd_deflate_init2(&(*session_ptr)->hd_deflater,\n@@ -5657,6 +5663,16 @@ ssize_t nghttp2_session_mem_recv(nghttp2_session *session, const uint8_t *in,\n           iframe->max_niv =\n               iframe->frame.hd.length / NGHTTP2_FRAME_SETTINGS_ENTRY_LENGTH + 1;\n \n+          if (iframe->max_niv - 1 > session->max_settings) {\n+            rv = nghttp2_session_terminate_session_with_reason(\n+                session, NGHTTP2_ENHANCE_YOUR_CALM,\n+                \"SETTINGS: too many setting entries\");\n+            if (nghttp2_is_fatal(rv)) {\n+              return rv;\n+            }\n+            return (ssize_t)inlen;\n+          }\n+\n           iframe->iv = nghttp2_mem_malloc(mem, sizeof(nghttp2_settings_entry) *\n                                                    iframe->max_niv);\n \n@@ -7425,6 +7441,11 @@ static int nghttp2_session_upgrade_internal(nghttp2_session *session,\n   if (settings_payloadlen % NGHTTP2_FRAME_SETTINGS_ENTRY_LENGTH) {\n     return NGHTTP2_ERR_INVALID_ARGUMENT;\n   }\n+  /* SETTINGS frame contains too many settings */\n+  if (settings_payloadlen / NGHTTP2_FRAME_SETTINGS_ENTRY_LENGTH\n+        > session->max_settings) {\n+    return NGHTTP2_ERR_TOO_MANY_SETTINGS;\n+  }\n   rv = nghttp2_frame_unpack_settings_payload2(&iv, &niv, settings_payload,\n                                               settings_payloadlen, mem);\n   if (rv != 0) {"
    },
    "modified_file_7": {
        "mod_filename": "lib/nghttp2_session.h",
        "status": "modified",
        "add_lines": 2,
        "dele_lines": 0,
        "patch": "@@ -267,6 +267,8 @@ struct nghttp2_session {\n   /* The maximum length of header block to send.  Calculated by the\n      same way as nghttp2_hd_deflate_bound() does. */\n   size_t max_send_header_block_length;\n+  /* The maximum number of settings accepted per SETTINGS frame. */\n+  size_t max_settings;\n   /* Next Stream ID. Made unsigned int to detect >= (1 << 31). */\n   uint32_t next_stream_id;\n   /* The last stream ID this session initiated.  For client session,"
    },
    "modified_file_8": {
        "mod_filename": "tests/main.c",
        "status": "modified",
        "add_lines": 2,
        "dele_lines": 0,
        "patch": "@@ -317,6 +317,8 @@ int main() {\n                    test_nghttp2_session_set_local_window_size) ||\n       !CU_add_test(pSuite, \"session_cancel_from_before_frame_send\",\n                    test_nghttp2_session_cancel_from_before_frame_send) ||\n+      !CU_add_test(pSuite, \"session_too_many_settings\",\n+                   test_nghttp2_session_too_many_settings) ||\n       !CU_add_test(pSuite, \"session_removed_closed_stream\",\n                    test_nghttp2_session_removed_closed_stream) ||\n       !CU_add_test(pSuite, \"session_pause_data\","
    },
    "modified_file_9": {
        "mod_filename": "tests/nghttp2_session_test.c",
        "status": "modified",
        "add_lines": 61,
        "dele_lines": 0,
        "patch": "@@ -10614,6 +10614,67 @@ void test_nghttp2_session_cancel_from_before_frame_send(void) {\n   nghttp2_session_del(session);\n }\n \n+void test_nghttp2_session_too_many_settings(void) {\n+  nghttp2_session *session;\n+  nghttp2_option *option;\n+  nghttp2_session_callbacks callbacks;\n+  nghttp2_frame frame;\n+  nghttp2_bufs bufs;\n+  nghttp2_buf *buf;\n+  ssize_t rv;\n+  my_user_data ud;\n+  nghttp2_settings_entry iv[3];\n+  nghttp2_mem *mem;\n+  nghttp2_outbound_item *item;\n+\n+  mem = nghttp2_mem_default();\n+  frame_pack_bufs_init(&bufs);\n+\n+  memset(&callbacks, 0, sizeof(nghttp2_session_callbacks));\n+  callbacks.on_frame_recv_callback = on_frame_recv_callback;\n+  callbacks.send_callback = null_send_callback;\n+\n+  nghttp2_option_new(&option);\n+  nghttp2_option_set_max_settings(option, 1);\n+\n+  nghttp2_session_client_new2(&session, &callbacks, &ud, option);\n+\n+  CU_ASSERT(1 == session->max_settings);\n+\n+  nghttp2_option_del(option);\n+\n+  iv[0].settings_id = NGHTTP2_SETTINGS_HEADER_TABLE_SIZE;\n+  iv[0].value = 3000;\n+\n+  iv[1].settings_id = NGHTTP2_SETTINGS_INITIAL_WINDOW_SIZE;\n+  iv[1].value = 16384;\n+\n+  nghttp2_frame_settings_init(&frame.settings, NGHTTP2_FLAG_NONE, dup_iv(iv, 2),\n+                              2);\n+\n+  rv = nghttp2_frame_pack_settings(&bufs, &frame.settings);\n+\n+  CU_ASSERT(0 == rv);\n+  CU_ASSERT(nghttp2_bufs_len(&bufs) > 0);\n+\n+  nghttp2_frame_settings_free(&frame.settings, mem);\n+\n+  buf = &bufs.head->buf;\n+  assert(nghttp2_bufs_len(&bufs) == nghttp2_buf_len(buf));\n+\n+  ud.frame_recv_cb_called = 0;\n+\n+  rv = nghttp2_session_mem_recv(session, buf->pos, nghttp2_buf_len(buf));\n+  CU_ASSERT((ssize_t)nghttp2_buf_len(buf) == rv);\n+\n+  item = nghttp2_session_get_next_ob_item(session);\n+  CU_ASSERT(NGHTTP2_GOAWAY == item->frame.hd.type);\n+\n+  nghttp2_bufs_reset(&bufs);\n+  nghttp2_bufs_free(&bufs);\n+  nghttp2_session_del(session);\n+}\n+\n static void\n prepare_session_removed_closed_stream(nghttp2_session *session,\n                                       nghttp2_hd_deflater *deflater) {"
    },
    "modified_file_10": {
        "mod_filename": "tests/nghttp2_session_test.h",
        "status": "modified",
        "add_lines": 1,
        "dele_lines": 0,
        "patch": "@@ -156,6 +156,7 @@ void test_nghttp2_session_repeated_priority_change(void);\n void test_nghttp2_session_repeated_priority_submission(void);\n void test_nghttp2_session_set_local_window_size(void);\n void test_nghttp2_session_cancel_from_before_frame_send(void);\n+void test_nghttp2_session_too_many_settings(void);\n void test_nghttp2_session_removed_closed_stream(void);\n void test_nghttp2_session_pause_data(void);\n void test_nghttp2_session_no_closed_streams(void);"
    }
}